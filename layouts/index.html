{{ define "sidebar" }}
{{ end }}

{{ define "main" }}

{{ if .Params.show_intro }}
<div class="home-intro">
  <h1 class="home-heading">{{ .Params.intro_heading }}</h1>
  <p class="home-text">{{ .Params.intro_text }}</p>
</div>
{{ end }}

<div class="hero-image" id="heroImage" data-src="" data-title="" data-location="" data-year="">
  <img id="heroImg" src="" alt="">
  <div class="hero-overlay">
    <div class="hero-title" id="heroTitle"></div>
    <div class="hero-meta" id="heroMeta"></div>
  </div>
</div>

<div class="filter-bar" id="filterBar">
  <div class="filter-group">
    <select id="regionFilter" class="filter-select">
      <option value="all">All Regions</option>
    </select>
    <select id="yearFilter" class="filter-select">
      <option value="all">All Years</option>
    </select>
    <button id="sortToggle" class="filter-select sort-btn">Newest First</button>
	<button id="randomizeBtn" class="filter-select sort-btn">Randomize</button>
	<button id="resetFilters" class="reset-btn">Reset</button>
  </div>
  <div class="filter-count" id="filterCount"></div>
</div>

<div class="photo-grid" id="photoGrid">
  {{ range where .Site.RegularPages "Section" "photos" }}
  <div class="photo-card" data-region="{{ .Params.region }}" data-title="{{ .Title }}" data-location="{{ .Params.location }}" data-year="{{ .Params.year }}" data-src="{{ .Params.image }}" data-date="{{ .Date.Format "2006-01-02" }}">
    <img src="{{ .Params.image }}" alt="{{ .Title }}" loading="lazy">
    <div class="card-overlay">
      <div class="card-title">{{ .Title }}</div>
      <div class="card-meta">{{ .Params.location }} &middot; {{ .Params.year }}</div>
    </div>
  </div>
  {{ end }}
</div>& 'C:\Program Files\Notepad++\notepad++.exe' C:\Users\darot\Documents\silvrshadz\layouts\index.html

<div class="load-more-wrap" id="loadMoreWrap">
  <button id="loadMoreBtn" class="load-more-btn">Load More</button>
</div>

<div class="lightbox" id="lightbox">
  <button class="lb-close" aria-label="Close">&#215;</button>
  <button class="lb-nav lb-prev" aria-label="Previous">&#8249;</button>
  <button class="lb-nav lb-next" aria-label="Next">&#8250;</button>
  <div class="lb-img-wrap">
    <img id="lbImg" src="" alt="">
  </div>
  <div class="lb-info">
    <div class="lb-title" id="lbTitle"></div>
    <div class="lb-meta" id="lbMeta"></div>
  </div>
  <div class="lb-counter" id="lbCounter"></div>
</div>

{{ end }}

{{ define "scripts" }}
<script>
var BATCH = 30;
var allCards = Array.prototype.slice.call(document.querySelectorAll('.photo-card'));
var filteredCards = allCards.slice();
var visibleCards = [];
var showCount = BATCH;
var sortNewest = true;

// Build region dropdown
var regions = [];
allCards.forEach(function(c) {
  var r = c.getAttribute('data-region');
  if (r && regions.indexOf(r) === -1) regions.push(r);
});
regions.sort();
var regionSelect = document.getElementById('regionFilter');
regions.forEach(function(r) {
  var opt = document.createElement('option');
  opt.value = r;
  opt.textContent = r.charAt(0).toUpperCase() + r.slice(1).replace(/-/g, ' ');
  regionSelect.appendChild(opt);
});

// Build year dropdown
var years = [];
allCards.forEach(function(c) {
  var y = c.getAttribute('data-year');
  if (y && years.indexOf(y) === -1) years.push(y);
});
years.sort().reverse();
var yearSelect = document.getElementById('yearFilter');
years.forEach(function(y) {
  var opt = document.createElement('option');
  opt.value = y;
  opt.textContent = y;
  yearSelect.appendChild(opt);
});

// Filter and display logic
function applyFilters() {
  var region = regionSelect.value;
  var year = yearSelect.value;

  filteredCards = allCards.filter(function(c) {
    var matchRegion = (region === 'all' || c.getAttribute('data-region') === region);
    var matchYear = (year === 'all' || c.getAttribute('data-year') === year);
    return matchRegion && matchYear;
  });

  // Sort
  filteredCards.sort(function(a, b) {
    var da = a.getAttribute('data-date');
    var db = b.getAttribute('data-date');
    if (sortNewest) return da < db ? 1 : da > db ? -1 : 0;
    return da > db ? 1 : da < db ? -1 : 0;
  });

  showCount = BATCH;
  renderGrid();
}

function renderGrid() {
  // Hide all cards first
  allCards.forEach(function(c) {
    c.style.display = 'none';
    c.classList.remove('reveal-visible');
    c.classList.remove('reveal-hidden');
  });

  // Reorder in DOM
  var grid = document.getElementById('photoGrid');
  filteredCards.forEach(function(c) {
    grid.appendChild(c);
  });

  // Show up to showCount
  visibleCards = filteredCards.slice(0, showCount);
  visibleCards.forEach(function(c) {
    c.style.display = '';
    c.classList.add('reveal-hidden');
  });

  // Update count
  var countEl = document.getElementById('filterCount');
  if (filteredCards.length === allCards.length) {
    countEl.textContent = filteredCards.length + ' photos';
  } else {
    countEl.textContent = 'Showing ' + visibleCards.length + ' of ' + filteredCards.length + ' photos';
  }

  // Load more button
  var loadMoreWrap = document.getElementById('loadMoreWrap');
  if (showCount >= filteredCards.length) {
    loadMoreWrap.style.display = 'none';
  } else {
    loadMoreWrap.style.display = '';
  }

  // Trigger reveal animation
  setTimeout(function() {
    var delay = 0;
    visibleCards.forEach(function(card) {
      var rect = card.getBoundingClientRect();
      if (rect.top < window.innerHeight + 100) {
        setTimeout(function() {
          card.classList.remove('reveal-hidden');
          card.classList.add('reveal-visible');
        }, delay);
        delay += 50;
      } else {
        card.classList.remove('reveal-hidden');
        card.classList.add('reveal-visible');
      }
    });
  }, 50);
}

function loadMore() {
  showCount += BATCH;
  renderGrid();
  // Scroll reveal for newly visible cards
  setTimeout(revealOnScroll, 100);
}

function revealOnScroll() {
  var hidden = document.querySelectorAll('.photo-card.reveal-hidden');
  var delay = 0;
  hidden.forEach(function(card) {
    var rect = card.getBoundingClientRect();
    if (rect.top < window.innerHeight - 60) {
      setTimeout(function() {
        card.classList.remove('reveal-hidden');
        card.classList.add('reveal-visible');
      }, delay);
      delay += 50;
    }
  });
}

// Event listeners
regionSelect.addEventListener('change', applyFilters);
yearSelect.addEventListener('change', applyFilters);

document.getElementById('sortToggle').addEventListener('click', function() {
  sortNewest = !sortNewest;
  this.textContent = sortNewest ? 'Newest First' : 'Oldest First';
  applyFilters();
});

document.getElementById('randomizeBtn').addEventListener('click', function() {
  for (var i = filteredCards.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = filteredCards[i];
    filteredCards[i] = filteredCards[j];
    filteredCards[j] = temp;
  }
  showCount = BATCH;
  renderGrid();
});

document.getElementById('resetFilters').addEventListener('click', function() {
  regionSelect.value = 'all';
  yearSelect.value = 'all';
  sortNewest = true;
  document.getElementById('sortToggle').textContent = 'Newest First';
  applyFilters();
});

document.getElementById('loadMoreBtn').addEventListener('click', loadMore);
window.addEventListener('scroll', revealOnScroll);

// Initial render
applyFilters();

// Lightbox
var lb = document.getElementById('lightbox');
var lbImg = document.getElementById('lbImg');
var lbTitle = document.getElementById('lbTitle');
var lbMeta = document.getElementById('lbMeta');
var lbCounter = document.getElementById('lbCounter');
var ci = 0;

function openLb(i) {
  ci = i;
  var c = visibleCards[ci];
  lbImg.src = c.getAttribute('data-src');
  lbImg.alt = c.getAttribute('data-title');
  updateLb();
  lb.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeLb() {
  lb.classList.remove('active');
  document.body.style.overflow = '';
  setTimeout(function() {
    lbImg.style.transition = 'none';
    lbImg.style.transform = 'scale(0.85)';
    lbImg.style.opacity = '0';
    setTimeout(function() {
      lbImg.style.transition = '';
      lbImg.style.transform = '';
      lbImg.style.opacity = '';
    }, 50);
  }, 400);
}

function updateLb() {
  var c = visibleCards[ci];
  lbTitle.textContent = c.getAttribute('data-title');
  lbMeta.textContent = c.getAttribute('data-location') + ' \u00B7 ' + c.getAttribute('data-year');
  lbCounter.textContent = (ci + 1) + ' / ' + visibleCards.length;
}

function nextLb() {
  lbImg.style.opacity = '0';
  lbImg.style.transform = 'scale(0.92)';
  setTimeout(function() {
    ci = (ci + 1) % visibleCards.length;
    var c = visibleCards[ci];
    var newSrc = c.getAttribute('data-src');
    var preload = new Image();
    preload.onload = function() {
      lbImg.src = newSrc;
      lbImg.alt = c.getAttribute('data-title');
      updateLb();
      setTimeout(function() {
        lbImg.style.opacity = '1';
        lbImg.style.transform = 'scale(1)';
      }, 50);
    };
    lbImg.removeAttribute('src');
    preload.src = newSrc;
  }, 250);
}

function prevLb() {
  lbImg.style.opacity = '0';
  lbImg.style.transform = 'scale(0.92)';
  setTimeout(function() {
    ci = (ci - 1 + visibleCards.length) % visibleCards.length;
    var c = visibleCards[ci];
    var newSrc = c.getAttribute('data-src');
    var preload = new Image();
    preload.onload = function() {
      lbImg.src = newSrc;
      lbImg.alt = c.getAttribute('data-title');
      updateLb();
      setTimeout(function() {
        lbImg.style.opacity = '1';
        lbImg.style.transform = 'scale(1)';
      }, 50);
    };
    lbImg.removeAttribute('src');
    preload.src = newSrc;
  }, 250);
}

allCards.forEach(function(c) {
  c.addEventListener('click', function() {
    var idx = visibleCards.indexOf(c);
    if (idx !== -1) openLb(idx);
  });
});

// Random hero image
var heroEl = document.getElementById('heroImage');
var heroImg = document.getElementById('heroImg');
var heroTitle = document.getElementById('heroTitle');
var heroMeta = document.getElementById('heroMeta');
var randIdx = Math.floor(Math.random() * allCards.length);
var randCard = allCards[randIdx];
heroEl.setAttribute('data-src', randCard.getAttribute('data-src'));
heroEl.setAttribute('data-title', randCard.getAttribute('data-title'));
heroEl.setAttribute('data-location', randCard.getAttribute('data-location'));
heroEl.setAttribute('data-year', randCard.getAttribute('data-year'));
heroImg.src = randCard.getAttribute('data-src');
heroImg.alt = randCard.getAttribute('data-title');
heroTitle.textContent = randCard.getAttribute('data-title');
heroMeta.textContent = randCard.getAttribute('data-location') + ' \u00B7 ' + randCard.getAttribute('data-year');

// Hero click opens lightbox
heroEl.addEventListener('click', function() {
  var heroSrc = this.getAttribute('data-src');
  for (var i = 0; i < allCards.length; i++) {
    if (allCards[i].getAttribute('data-src') === heroSrc) {
      if (visibleCards.indexOf(allCards[i]) === -1) {
        visibleCards = filteredCards.slice();
      }
      var idx = visibleCards.indexOf(allCards[i]);
      if (idx !== -1) openLb(idx);
      break;
    }
  }
});

document.querySelector('.lb-close').addEventListener('click', closeLb);
document.querySelector('.lb-prev').addEventListener('click', prevLb);
document.querySelector('.lb-next').addEventListener('click', nextLb);
lb.addEventListener('click', function(e) { if (e.target === lb) closeLb(); });

document.addEventListener('keydown', function(e) {
  if (!lb.classList.contains('active')) return;
  if (e.key === 'Escape') closeLb();
  if (e.key === 'ArrowRight') nextLb();
  if (e.key === 'ArrowLeft') prevLb();
});
</script>
{{ end }}
