{{ define "main" }}

{{ if .Sections }}
{{/* This is the main Photographs page — show gallery categories */}}
<div class="gallery-index">
  {{ range .Sections }}
  <a href="{{ .Permalink }}" class="gallery-category">
    {{ if .Params.cover }}
    <img src="{{ .Params.cover }}" alt="{{ .Title }}" loading="lazy">
    {{ end }}
    <div class="gallery-category-title">{{ .Title }}</div>
  </a>
  {{ end }}
</div>

{{ else }}
{{/* This is an individual gallery — show photo grid with lightbox */}}
<h1 class="gallery-heading">{{ .Title }}</h1>

<div class="photo-grid" id="photoGrid">
  {{ range .Pages }}
  <div class="photo-card" data-title="{{ .Title }}" data-location="{{ .Params.location }}" data-year="{{ .Params.year }}" data-src="{{ .Params.image }}">
    <img src="{{ .Params.image }}" alt="{{ .Title }}" loading="lazy">
    <div class="card-overlay">
      <div class="card-title">{{ .Title }}</div>
      <div class="card-meta">{{ .Params.location }} &middot; {{ .Params.year }}</div>
    </div>
  </div>
  {{ end }}
</div>

<div class="lightbox" id="lightbox">
  <button class="lb-close" aria-label="Close">&#215;</button>
  <button class="lb-nav lb-prev" aria-label="Previous">&#8249;</button>
  <button class="lb-nav lb-next" aria-label="Next">&#8250;</button>
  <div class="lb-img-wrap">
    <img id="lbImg" src="" alt="">
  </div>
  <div class="lb-info">
    <div class="lb-title" id="lbTitle"></div>
    <div class="lb-meta" id="lbMeta"></div>
  </div>
  <div class="lb-counter" id="lbCounter"></div>
</div>
{{ end }}

{{ end }}

{{ define "scripts" }}
{{ if not .Sections }}
<script>
var allCards = Array.prototype.slice.call(document.querySelectorAll('.photo-card'));
var visibleCards = allCards.slice();
var lb = document.getElementById('lightbox');
var lbImg = document.getElementById('lbImg');
var lbTitle = document.getElementById('lbTitle');
var lbMeta = document.getElementById('lbMeta');
var lbCounter = document.getElementById('lbCounter');
var ci = 0;

function openLb(i) {
  ci = i;
  updateLb();
  lb.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeLb() {
  lb.classList.remove('active');
  document.body.style.overflow = '';
  setTimeout(function() {
    lbImg.style.transition = 'none';
    lbImg.style.transform = 'scale(0.85)';
    lbImg.style.opacity = '0';
    setTimeout(function() {
      lbImg.style.transition = '';
      lbImg.style.transform = '';
      lbImg.style.opacity = '';
    }, 50);
  }, 400);
}

function updateLb() {
  var c = visibleCards[ci];
  lbImg.src = c.getAttribute('data-src');
  lbImg.alt = c.getAttribute('data-title');
  lbTitle.textContent = c.getAttribute('data-title');
  lbMeta.textContent = c.getAttribute('data-location') + ' \u00B7 ' + c.getAttribute('data-year');
  lbCounter.textContent = (ci + 1) + ' / ' + visibleCards.length;
}

function nextLb() {
  lbImg.style.opacity = '0';
  lbImg.style.transform = 'scale(0.92)';
  setTimeout(function() {
    ci = (ci + 1) % visibleCards.length;
    updateLb();
    setTimeout(function() {
      lbImg.style.opacity = '1';
      lbImg.style.transform = 'scale(1)';
    }, 50);
  }, 250);
}

function prevLb() {
  lbImg.style.opacity = '0';
  lbImg.style.transform = 'scale(0.92)';
  setTimeout(function() {
    ci = (ci - 1 + visibleCards.length) % visibleCards.length;
    updateLb();
    setTimeout(function() {
      lbImg.style.opacity = '1';
      lbImg.style.transform = 'scale(1)';
    }, 50);
  }, 250);
}

allCards.forEach(function(c) {
  c.addEventListener('click', function() {
    var idx = visibleCards.indexOf(c);
    if (idx !== -1) openLb(idx);
  });
});

document.querySelector('.lb-close').addEventListener('click', closeLb);
document.querySelector('.lb-prev').addEventListener('click', prevLb);
document.querySelector('.lb-next').addEventListener('click', nextLb);
lb.addEventListener('click', function(e) { if (e.target === lb) closeLb(); });

document.addEventListener('keydown', function(e) {
  if (!lb.classList.contains('active')) return;
  if (e.key === 'Escape') closeLb();
  if (e.key === 'ArrowRight') nextLb();
  if (e.key === 'ArrowLeft') prevLb();
});
</script>
{{ end }}
{{ end }}